I"Æ<p>â€‹		ä½ å¯èƒ½ä¸€ç›´å°±å¾ˆå¥½å¥‡ï¼šå½“æˆ‘æŠŠä¸€ä¸ª YAML æ–‡ä»¶æäº¤ç»™ Kubernetes ä¹‹åï¼Œå®ƒç©¶ç«Ÿæ˜¯å¦‚ä½•åˆ›å»ºå‡ºä¸€ä¸ª API å¯¹è±¡çš„å‘¢ï¼Ÿè¿™å¾—ä»å£°æ˜å¼ API çš„è®¾è®¡è°ˆèµ·äº†ã€‚åœ¨ Kubernetes é¡¹ç›®ä¸­ï¼Œä¸€ä¸ª API å¯¹è±¡åœ¨ Etcd é‡Œçš„å®Œæ•´èµ„æºè·¯å¾„ï¼Œæ˜¯ç”±ï¼šGroupï¼ˆAPI ç»„ï¼‰ã€Versionï¼ˆAPI ç‰ˆæœ¬ï¼‰å’Œ Resourceï¼ˆAPI èµ„æºç±»å‹ï¼‰ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆçš„ã€‚</p>

<p>é€šè¿‡è¿™æ ·çš„ç»“æ„ï¼Œæ•´ä¸ª Kubernetes é‡Œçš„æ‰€æœ‰ API å¯¹è±¡ï¼Œå®é™…ä¸Šå°±å¯ä»¥ç”¨å¦‚ä¸‹çš„æ ‘å½¢ç»“æ„è¡¨ç¤ºå‡ºæ¥ï¼š</p>

<p><img src="/Users/zhangchao/Library/Application Support/typora-user-images/image-20200305162106934.png" alt="image-20200305162106934" /></p>

<p>åœ¨è¿™å¹…å›¾ä¸­ï¼Œä½ å¯ä»¥å¾ˆæ¸…æ¥šåœ°çœ‹åˆ° Kubernetes é‡Œ API å¯¹è±¡çš„ç»„ç»‡æ–¹å¼ï¼Œå…¶å®æ˜¯å±‚å±‚é€’è¿›çš„ã€‚æ¯”å¦‚ï¼Œç°åœ¨æˆ‘è¦å£°æ˜è¦åˆ›å»ºä¸€ä¸ª CronJob å¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘çš„ YAML æ–‡ä»¶çš„å¼€å§‹éƒ¨åˆ†ä¼šè¿™ä¹ˆå†™ï¼š</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v2alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">CronJob</span>
<span class="nn">...</span>
</code></pre></div></div>

<p>åœ¨è¿™ä¸ª YAML æ–‡ä»¶ä¸­ï¼Œâ€œCronJobâ€å°±æ˜¯è¿™ä¸ª API å¯¹è±¡çš„èµ„æºç±»å‹ï¼ˆResourceï¼‰ï¼Œâ€œbatchâ€å°±æ˜¯å®ƒçš„ç»„ï¼ˆGroupï¼‰ï¼Œv2alpha1 å°±æ˜¯å®ƒçš„ç‰ˆæœ¬ï¼ˆVersionï¼‰ã€‚å½“æˆ‘ä»¬æäº¤äº†è¿™ä¸ª YAML æ–‡ä»¶ä¹‹åï¼ŒKubernetes å°±ä¼šæŠŠè¿™ä¸ª YAML æ–‡ä»¶é‡Œæè¿°çš„å†…å®¹ï¼Œè½¬æ¢æˆ Kubernetes é‡Œçš„ä¸€ä¸ª CronJob å¯¹è±¡ã€‚</p>

<p>é‚£ä¹ˆï¼ŒKubernetes æ˜¯å¦‚ä½•å¯¹ Resourceã€Group å’Œ Version è¿›è¡Œè§£æï¼Œä»è€Œåœ¨ Kubernetes é¡¹ç›®é‡Œæ‰¾åˆ° CronJob å¯¹è±¡çš„å®šä¹‰å‘¢ï¼Ÿ</p>

<p><strong>é¦–å…ˆï¼ŒKubernetes ä¼šåŒ¹é… API å¯¹è±¡çš„ç»„</strong>ã€‚</p>

<blockquote>
  <p>éœ€è¦æ˜ç¡®çš„æ˜¯ï¼Œå¯¹äº Kubernetes é‡Œçš„æ ¸å¿ƒ API å¯¹è±¡ï¼Œæ¯”å¦‚ï¼šPodã€Node ç­‰ï¼Œæ˜¯ä¸éœ€è¦ Group çš„ï¼ˆå³ï¼šå®ƒä»¬ Group æ˜¯â€œâ€ï¼‰ã€‚æ‰€ä»¥ï¼Œå¯¹äºè¿™äº› API å¯¹è±¡æ¥è¯´ï¼ŒKubernetes ä¼šç›´æ¥åœ¨ /api è¿™ä¸ªå±‚çº§è¿›è¡Œä¸‹ä¸€æ­¥çš„åŒ¹é…è¿‡ç¨‹ã€‚è€Œå¯¹äº CronJob ç­‰éæ ¸å¿ƒ API å¯¹è±¡æ¥è¯´ï¼ŒKubernetes å°±å¿…é¡»åœ¨ /apis è¿™ä¸ªå±‚çº§é‡ŒæŸ¥æ‰¾å®ƒå¯¹åº”çš„ Groupï¼Œè¿›è€Œæ ¹æ®â€œbatchâ€è¿™ä¸ª Group çš„åå­—ï¼Œæ‰¾åˆ° /apis/batchã€‚ä¸éš¾å‘ç°ï¼Œè¿™äº› API Group çš„åˆ†ç±»æ˜¯ä»¥å¯¹è±¡åŠŸèƒ½ä¸ºä¾æ®çš„ï¼Œæ¯”å¦‚ Job å’Œ CronJob å°±éƒ½å±äºâ€œbatchâ€ ï¼ˆç¦»çº¿ä¸šåŠ¡ï¼‰è¿™ä¸ª Groupã€‚</p>
</blockquote>

<p><strong>ç„¶åï¼ŒKubernetes ä¼šè¿›ä¸€æ­¥åŒ¹é…åˆ° API å¯¹è±¡çš„ç‰ˆæœ¬å·ã€‚</strong></p>

<p>å¯¹äº CronJob è¿™ä¸ª API å¯¹è±¡æ¥è¯´ï¼ŒKubernetes åœ¨ batch è¿™ä¸ª Group ä¸‹ï¼ŒåŒ¹é…åˆ°çš„ç‰ˆæœ¬å·å°±æ˜¯ v2alpha1ã€‚åœ¨ Kubernetes ä¸­ï¼ŒåŒä¸€ç§ API å¯¹è±¡å¯ä»¥æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œè¿™æ­£æ˜¯ Kubernetes è¿›è¡Œ API ç‰ˆæœ¬åŒ–ç®¡ç†çš„é‡è¦æ‰‹æ®µã€‚è¿™æ ·ï¼Œæ¯”å¦‚åœ¨ CronJob çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¯¹äºä¼šå½±å“åˆ°ç”¨æˆ·çš„å˜æ›´å°±å¯ä»¥é€šè¿‡å‡çº§æ–°ç‰ˆæœ¬æ¥å¤„ç†ï¼Œä»è€Œä¿è¯äº†å‘åå…¼å®¹ã€‚</p>

<p><strong>æœ€åï¼ŒKubernetes ä¼šåŒ¹é… API å¯¹è±¡çš„èµ„æºç±»å‹ã€‚</strong></p>

<p>åœ¨å‰é¢åŒ¹é…åˆ°æ­£ç¡®çš„ç‰ˆæœ¬ä¹‹åï¼ŒKubernetes å°±çŸ¥é“ï¼Œæˆ‘è¦åˆ›å»ºçš„åŸæ¥æ˜¯ä¸€ä¸ª /apis/batch/v2alpha1 ä¸‹çš„ CronJob å¯¹è±¡ã€‚è¿™æ—¶å€™ï¼ŒAPIServer å°±å¯ä»¥ç»§ç»­åˆ›å»ºè¿™ä¸ª CronJob å¯¹è±¡äº†ã€‚</p>

<p>æ›´ç»†èŠ‚çš„ï¼Œå¯ä»¥ç”¨å¦‚ä¸‹æ‰€ç¤ºæµç¨‹å›¾æ¥é˜è¿°è¿™ä¸ªåˆ›å»ºè¿‡ç¨‹</p>

<p><img src="/Users/zhangchao/Library/Application Support/typora-user-images/image-20200305162845449.png" alt="image-20200305162845449" /></p>

<p><strong>é¦–å…ˆ</strong>ï¼Œå½“æˆ‘ä»¬å‘èµ·äº†åˆ›å»º CronJob çš„ POST è¯·æ±‚ä¹‹åï¼Œæˆ‘ä»¬ç¼–å†™çš„ YAML çš„ä¿¡æ¯å°±è¢«æäº¤ç»™äº† APIServerã€‚è€Œ APIServer çš„ç¬¬ä¸€ä¸ªåŠŸèƒ½ï¼Œå°±æ˜¯è¿‡æ»¤è¿™ä¸ªè¯·æ±‚ï¼Œå¹¶å®Œæˆä¸€äº›å‰ç½®æ€§çš„å·¥ä½œï¼Œæ¯”å¦‚æˆæƒã€è¶…æ—¶å¤„ç†ã€å®¡è®¡ç­‰ã€‚</p>

<p><strong>ç„¶å</strong>ï¼Œè¯·æ±‚ä¼šè¿›å…¥ MUX å’Œ Routes æµç¨‹ã€‚å¦‚æœä½ ç¼–å†™è¿‡ Web Server çš„è¯å°±ä¼šçŸ¥é“ï¼ŒMUX å’Œ Routes æ˜¯ APIServer å®Œæˆ URL å’Œ Handler ç»‘å®šçš„åœºæ‰€ã€‚è€Œ APIServer çš„ Handler è¦åšçš„äº‹æƒ…ï¼Œå°±æ˜¯æŒ‰ç…§æˆ‘åˆšåˆšä»‹ç»çš„åŒ¹é…è¿‡ç¨‹ï¼Œæ‰¾åˆ°å¯¹åº”çš„ CronJob ç±»å‹å®šä¹‰ã€‚</p>

<p><strong>æ¥ç€</strong>ï¼ŒAPIServer æœ€é‡è¦çš„èŒè´£å°±æ¥äº†ï¼šæ ¹æ®è¿™ä¸ª CronJob ç±»å‹å®šä¹‰ï¼Œä½¿ç”¨ç”¨æˆ·æäº¤çš„ YAML æ–‡ä»¶é‡Œçš„å­—æ®µï¼Œåˆ›å»ºä¸€ä¸ª CronJob å¯¹è±¡ã€‚è€Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒAPIServer ä¼šè¿›è¡Œä¸€ä¸ª Convert å·¥ä½œï¼Œå³ï¼šæŠŠç”¨æˆ·æäº¤çš„ YAML æ–‡ä»¶ï¼Œè½¬æ¢æˆä¸€ä¸ªå«ä½œ Super Version çš„å¯¹è±¡ï¼Œå®ƒæ­£æ˜¯è¯¥ API èµ„æºç±»å‹æ‰€æœ‰ç‰ˆæœ¬çš„å­—æ®µå…¨é›†ã€‚è¿™æ ·ç”¨æˆ·æäº¤çš„ä¸åŒç‰ˆæœ¬çš„ YAML æ–‡ä»¶ï¼Œå°±éƒ½å¯ä»¥ç”¨è¿™ä¸ª Super Version å¯¹è±¡æ¥è¿›è¡Œå¤„ç†äº†ã€‚</p>

<p><strong>æ¥ä¸‹æ¥</strong>ï¼ŒAPIServer ä¼šå…ˆåè¿›è¡Œ Admission() å’Œ Validation() æ“ä½œã€‚å¦‚ Admission Controller å’Œ Initializeréƒ½å±äº Admission çš„å†…å®¹ã€‚è€Œ Validationï¼Œåˆ™è´Ÿè´£éªŒè¯è¿™ä¸ªå¯¹è±¡é‡Œçš„å„ä¸ªå­—æ®µæ˜¯å¦åˆæ³•ã€‚è¿™ä¸ªè¢«éªŒè¯è¿‡çš„ API å¯¹è±¡ï¼Œéƒ½ä¿å­˜åœ¨äº† APIServer é‡Œä¸€ä¸ªå«ä½œ Registry çš„æ•°æ®ç»“æ„ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦ä¸€ä¸ª API å¯¹è±¡çš„å®šä¹‰èƒ½åœ¨ Registry é‡ŒæŸ¥åˆ°ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ Kubernetes API å¯¹è±¡ã€‚</p>

<p><strong>æœ€å</strong>ï¼ŒAPIServer ä¼šæŠŠéªŒè¯è¿‡çš„ API å¯¹è±¡è½¬æ¢æˆç”¨æˆ·æœ€åˆæäº¤çš„ç‰ˆæœ¬ï¼Œè¿›è¡Œåºåˆ—åŒ–æ“ä½œï¼Œå¹¶è°ƒç”¨ Etcd çš„ API æŠŠå®ƒä¿å­˜èµ·æ¥ã€‚ç”±æ­¤å¯è§ï¼Œå£°æ˜å¼ API å¯¹äº Kubernetes æ¥è¯´éå¸¸é‡è¦ã€‚æ‰€ä»¥ï¼ŒAPIServer è¿™æ ·ä¸€ä¸ªåœ¨å…¶ä»–é¡¹ç›®é‡Œâ€œå¹³æ·¡æ— å¥‡â€çš„ç»„ä»¶ï¼Œå´æˆäº† Kubernetes é¡¹ç›®çš„é‡ä¸­ä¹‹é‡ã€‚å®ƒä¸ä»…æ˜¯ Google Borg è®¾è®¡æ€æƒ³çš„é›†ä¸­ä½“ç°ï¼Œä¹Ÿæ˜¯ Kubernetes é¡¹ç›®é‡Œå”¯ä¸€ä¸€ä¸ªè¢« Google å…¬å¸å’Œ RedHatå…¬å¸åŒé‡æ§åˆ¶ã€å…¶ä»–åŠ¿åŠ›æ ¹æœ¬æ— æ³•å‚ä¸å…¶ä¸­çš„ç»„ä»¶ã€‚æ­¤å¤–ï¼Œç”±äºåŒæ—¶è¦å…¼é¡¾æ€§èƒ½ã€API å®Œå¤‡æ€§ã€ç‰ˆæœ¬åŒ–ã€å‘åå…¼å®¹ç­‰å¾ˆå¤šå·¥ç¨‹åŒ–æŒ‡æ ‡ï¼Œæ‰€ä»¥ Kubernetes å›¢é˜Ÿåœ¨ APIServer é¡¹ç›®é‡Œå¤§é‡ä½¿ç”¨äº† Go è¯­è¨€çš„ä»£ç ç”ŸæˆåŠŸèƒ½ï¼Œæ¥è‡ªåŠ¨åŒ–è¯¸å¦‚ Convertã€DeepCopy ç­‰ä¸ API èµ„æºç›¸å…³çš„æ“ä½œã€‚è¿™éƒ¨åˆ†è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ï¼Œæ›¾ä¸€åº¦å åˆ° Kubernetes é¡¹ç›®æ€»ä»£ç çš„ 20%~30%ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä½•ï¼Œåœ¨è¿‡å»å¾ˆé•¿ä¸€æ®µæ—¶é—´é‡Œï¼Œåœ¨è¿™æ ·ä¸€ä¸ªæå…¶â€œå¤æ‚â€çš„ APIServer ä¸­ï¼Œæ·»åŠ ä¸€ä¸ª Kubernetes é£æ ¼çš„ API èµ„æºç±»å‹ï¼Œæ˜¯ä¸€ä¸ªéå¸¸å›°éš¾çš„å·¥ä½œã€‚</p>

<p>ä¸è¿‡ï¼Œåœ¨ Kubernetes v1.7 ä¹‹åï¼Œè¿™ä¸ªå·¥ä½œå°±å˜å¾—è½»æ¾å¾—å¤šäº†ã€‚è¿™ï¼Œå½“ç„¶å¾—ç›Šäºä¸€ä¸ªå…¨æ–°çš„ API æ’ä»¶æœºåˆ¶ï¼šCRDã€‚CRD çš„å…¨ç§°æ˜¯ Custom Resource Definitionã€‚é¡¾åæ€ä¹‰ï¼Œå®ƒæŒ‡çš„å°±æ˜¯ï¼Œå…è®¸ç”¨æˆ·åœ¨ Kubernetes ä¸­æ·»åŠ ä¸€ä¸ªè·Ÿ Podã€Node ç±»ä¼¼çš„ã€æ–°çš„ API èµ„æºç±»å‹ï¼Œå³ï¼šè‡ªå®šä¹‰ API èµ„æºã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸º Kubernetes æ·»åŠ ä¸€ä¸ªåå« Network çš„ API èµ„æºç±»å‹ã€‚å®ƒçš„ä½œç”¨æ˜¯ï¼Œä¸€æ—¦ç”¨æˆ·åˆ›å»ºä¸€ä¸ª Network å¯¹è±¡ï¼Œé‚£ä¹ˆ Kubernetes å°±åº”è¯¥ä½¿ç”¨è¿™ä¸ªå¯¹è±¡å®šä¹‰çš„ç½‘ç»œå‚æ•°ï¼Œè°ƒç”¨çœŸå®çš„ç½‘ç»œæ’ä»¶ï¼Œæ¯”å¦‚ Neutron é¡¹ç›®ï¼Œä¸ºç”¨æˆ·åˆ›å»ºä¸€ä¸ªçœŸæ­£çš„â€œç½‘ç»œâ€ã€‚è¿™æ ·ï¼Œå°†æ¥ç”¨æˆ·åˆ›å»ºçš„ Podï¼Œå°±å¯ä»¥å£°æ˜ä½¿ç”¨è¿™ä¸ªâ€œç½‘ç»œâ€äº†ã€‚</p>

<p>é¦–å…ˆï¼Œæˆ‘å°†åˆ›å»ºè‡ªå®šä¹‰APIèµ„æºå¯¹è±¡çš„è¿‡ç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼š</p>

<ol>
  <li>åˆ›å»ºæœåŠ¡ç«¯èµ„æºè®°å½•</li>
  <li>å®šä¹‰èµ„æºå±æ€§ï¼Œç”Ÿæˆèµ„æºè®¿é—®å®¢æˆ·ç«¯</li>
  <li>åˆ›å»ºè‡ªå®šä¹‰æ§åˆ¶å™¨ï¼Œç¼–å†™ä¸šåŠ¡é€»è¾‘</li>
</ol>

<h4 id="ä¸€åˆ›å»ºæœåŠ¡ç«¯èµ„æºè®°å½•">ä¸€ã€<strong>åˆ›å»ºæœåŠ¡ç«¯èµ„æºè®°å½•</strong></h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> crd_network.yaml
</code></pre></div></div>

<p>crd_network å†…å®¹å¦‚ä¸‹ï¼š</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">crd_network.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apiextensions.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">CustomResourceDefinition</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">networks.cloudteam.ztgame.com</span>  
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">group</span><span class="pi">:</span> <span class="s">cloudteam.ztgame.com</span> <span class="c1"># apiç»„</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span> <span class="c1"># apiç‰ˆæœ¬</span>
  <span class="na">names</span><span class="pi">:</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">Network</span> <span class="c1"># CRçš„èµ„æºç±»å‹</span>
    <span class="na">plural</span><span class="pi">:</span> <span class="s">networks</span> <span class="c1"># å¤æ•°æ˜¯ networks</span>
  <span class="na">scope</span><span class="pi">:</span> <span class="s">Namespaced</span> <span class="c1"># å£°æ˜Networkå¯¹è±¡çš„scopeæ˜¯Namespacedï¼Œå³ï¼šæˆ‘ä»¬å®šä¹‰çš„è¿™ä¸ªNetworkæ˜¯ä¸€ä¸ªå±äºæŸä¸ª Namespaceçš„å¯¹è±¡ï¼Œç±»ä¼¼äºPod</span>
</code></pre></div></div>

<p>åœ¨è¿™ä¸ª CRD ä¸­ï¼Œæˆ‘æŒ‡å®šäº†â€œgroup: cloudteam.ztgame.comâ€ï¼Œâ€œversion: v1â€è¿™æ ·çš„ API ä¿¡æ¯ï¼Œä¹ŸæŒ‡å®šäº†è¿™ä¸ª CR çš„èµ„æºç±»å‹å«ä½œ Networkï¼Œå¤æ•°ï¼ˆpluralï¼‰æ˜¯ networksã€‚ç„¶åï¼Œæˆ‘è¿˜å£°æ˜äº†å®ƒçš„ scope æ˜¯ Namespacedï¼Œå³ï¼šæˆ‘ä»¬å®šä¹‰çš„è¿™ä¸ª Network æ˜¯ä¸€ä¸ªå±äº Namespace çš„å¯¹è±¡ï¼Œç±»ä¼¼äº Podã€‚</p>

<p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å·²ç»åœ¨æœåŠ¡ç«¯å»ºç«‹äº†èµ„æºè®°å½•ï¼Œå¯ä»¥åˆ›å»ºNetwork APIèµ„æºå®ä¾‹äº†ï¼Œä¸‹é¢åˆ›å»ºä¸€ä¸ªNetworkèµ„æºå®ä¾‹</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> example_network.yaml
</code></pre></div></div>

<p>example_network.yaml æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼ŒapiGroupä¸ºæˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„cloudteam.ztgame.comï¼Œç‰ˆæœ¬ä¸ºv1, Kindä¸ºNetworkï¼Œ<strong>ä½†Specæˆ‘ä»¬å¹¶æ²¡æœ‰å®šä¹‰ï¼Œä¸ºä½•ä¹Ÿåˆ›å»ºæˆåŠŸäº†å‘¢ï¼Ÿ</strong></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">cloudteam.ztgame.com/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Network</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">example-network</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">cidr</span><span class="pi">:</span> <span class="s2">"</span><span class="s">192.168.0.0/16"</span>
  <span class="na">gateway</span><span class="pi">:</span> <span class="s2">"</span><span class="s">192.168.0.1"</span>
</code></pre></div></div>

<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒNetworkæ²¡æœ‰å’Œæ§åˆ¶å™¨ç»‘å®šï¼Œk8sçš„æ§åˆ¶å¾ªç¯ä¸ä¼šå»è°ƒè°æˆ‘ä»¬åˆ›å»ºNetworkå®ä¾‹ï¼Œä»…ä»…åªæ˜¯åªæ˜¯å°†è¿™ä¸ªè‡ªå®šä¹‰èµ„æºè®°å½•åœ¨äº†etcdæ•°æ®é‡Œã€‚å› æ­¤ï¼Œspceé‡Œçš„cidr,å’ŒgatewayæœåŠ¡ç«¯éƒ½æ˜¯ä¸å…³å¿ƒçš„ï¼Œåªæœ‰æ§åˆ¶å™¨å»è·å–èµ„æºå¯¹è±¡ç”¨æ¥å¯¹æ¯”è°ƒè°çš„æ—¶å€™ï¼Œæ‰ä¼šå…³å¿ƒèµ„æºçš„å…·ä½“å±æ€§</p>

<h4 id="äºŒå®šä¹‰èµ„æºå±æ€§ç”Ÿæˆèµ„æºè®¿é—®å®¢æˆ·ç«¯">äºŒã€å®šä¹‰èµ„æºå±æ€§ï¼Œç”Ÿæˆèµ„æºè®¿é—®å®¢æˆ·ç«¯</h4>

<p>é¦–å…ˆï¼Œæˆ‘è¦åœ¨ GOPATH ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªç»“æ„å¦‚ä¸‹çš„é¡¹ç›®ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nv">$ </span>tree <span class="nv">$GOPATH</span>/src/github.com/&lt;your-name&gt;/k8s-controller-custom-resource
<span class="nb">.</span>
â”œâ”€â”€ controller.go
â”œâ”€â”€ crd
â”‚   â””â”€â”€ network.yaml
â”œâ”€â”€ example
â”‚   â””â”€â”€ example-network.yaml
â”œâ”€â”€ main.go
â””â”€â”€ pkg
    â””â”€â”€ apis
        â””â”€â”€ cloudteam
            â”œâ”€â”€ register.go
            â””â”€â”€ v1
                â”œâ”€â”€ doc.go
                â”œâ”€â”€ register.go
                â””â”€â”€ types.go
</code></pre></div></div>

<p>å…¶ä¸­ï¼Œpkg/apis/cloudteam å°±æ˜¯ API ç»„çš„åå­—ï¼Œv1 æ˜¯ç‰ˆæœ¬ï¼Œè€Œ v1 ä¸‹é¢çš„ types.go æ–‡ä»¶é‡Œï¼Œåˆ™å®šä¹‰äº† Network å¯¹è±¡çš„å®Œæ•´æè¿°ã€‚</p>

<p>ç„¶åï¼Œæˆ‘åœ¨ pkg/apis/cloudteam ç›®å½•ä¸‹åˆ›å»ºäº†ä¸€ä¸ª register.go æ–‡ä»¶ï¼Œç”¨æ¥æ”¾ç½®åé¢è¦ç”¨åˆ°çš„å…¨å±€å˜é‡ã€‚è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">cloudteam</span>

<span class="k">const</span> <span class="p">(</span>
 <span class="n">GroupName</span> <span class="o">=</span> <span class="s">"cloudteam.ztgame.com"</span>
 <span class="n">Version</span>   <span class="o">=</span> <span class="s">"v1"</span>
<span class="p">)</span>
</code></pre></div></div>

<p>æ¥ç€ï¼Œæˆ‘éœ€è¦åœ¨ pkg/apis/cloudteam ç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ª doc.go æ–‡ä»¶ï¼ˆGolang çš„æ–‡æ¡£æºæ–‡ä»¶ï¼‰ã€‚è¿™ä¸ªæ–‡ä»¶é‡Œçš„å†…å®¹å¦‚ä¸‹æ‰€ç¤º:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// +k8s:deepcopy-gen=package</span>

<span class="c">// +groupName=cloudteam.ztgame.com</span>
<span class="k">package</span> <span class="n">v1</span>
</code></pre></div></div>

<p>åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œä½ ä¼šçœ‹åˆ° +[=value]æ ¼å¼çš„æ³¨é‡Šï¼Œè¿™å°±æ˜¯ Kubernetes è¿›è¡Œä»£ç ç”Ÿæˆè¦ç”¨çš„ Annotation é£æ ¼çš„æ³¨é‡Šã€‚å…¶ä¸­ï¼Œ+k8s:deepcopy-gen=package æ„æ€æ˜¯è¯·ä¸ºæ•´ä¸ª v1 åŒ…é‡Œçš„æ‰€æœ‰ç±»å‹å®šä¹‰è‡ªåŠ¨ç”Ÿæˆ DeepCopy æ–¹æ³•ï¼›è€Œ+groupName=samplecrd.k8s.ioï¼Œåˆ™å®šä¹‰äº†è¿™ä¸ªåŒ…å¯¹åº”çš„ API ç»„çš„åå­—ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™äº›å®šä¹‰åœ¨ doc.go æ–‡ä»¶çš„æ³¨é‡Šï¼Œèµ·åˆ°çš„æ˜¯å…¨å±€çš„ä»£ç ç”Ÿæˆæ§åˆ¶çš„ä½œç”¨ï¼Œæ‰€ä»¥ä¹Ÿè¢«ç§°ä¸º Global Tagsã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘éœ€è¦æ·»åŠ  types.go æ–‡ä»¶ã€‚é¡¾åæ€ä¹‰ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å®šä¹‰ä¸€ä¸ª Network ç±»å‹åˆ°åº•æœ‰å“ªäº›å­—æ®µï¼ˆæ¯”å¦‚ï¼Œspec å­—æ®µé‡Œçš„å†…å®¹ï¼‰ã€‚è¿™ä¸ªæ–‡ä»¶çš„ä¸»è¦å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">package</span> <span class="n">v1</span>
<span class="o">...</span>
<span class="c">// +genclient</span>
<span class="c">// +genclient:noStatus</span>
<span class="c">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span>

<span class="c">// Network describes a Network resource</span>
<span class="k">type</span> <span class="n">Network</span> <span class="k">struct</span> <span class="p">{</span>
 <span class="c">// TypeMeta is the metadata for the resource, like kind and apiversion</span>
 <span class="n">metav1</span><span class="o">.</span><span class="n">TypeMeta</span> <span class="s">`json:",inline"`</span>
 <span class="c">// ObjectMeta contains the metadata for the particular object, including</span>
 <span class="c">// things like...</span>
 <span class="c">//  - name</span>
 <span class="c">//  - namespace</span>
 <span class="c">//  - self link</span>
 <span class="c">//  - labels</span>
 <span class="c">//  - ... etc ...</span>
 <span class="n">metav1</span><span class="o">.</span><span class="n">ObjectMeta</span> <span class="s">`json:"metadata,omitempty"`</span>
 
 <span class="n">Spec</span> <span class="n">networkspec</span> <span class="s">`json:"spec"`</span>
<span class="p">}</span>
<span class="c">// networkspec is the spec for a Network resource</span>
<span class="k">type</span> <span class="n">networkspec</span> <span class="k">struct</span> <span class="p">{</span>
 <span class="n">Cidr</span>    <span class="kt">string</span> <span class="s">`json:"cidr"`</span>
 <span class="n">Gateway</span> <span class="kt">string</span> <span class="s">`json:"gateway"`</span>
<span class="p">}</span>

<span class="c">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span>

<span class="c">// NetworkList is a list of Network resources</span>
<span class="k">type</span> <span class="n">NetworkList</span> <span class="k">struct</span> <span class="p">{</span>
 <span class="n">metav1</span><span class="o">.</span><span class="n">TypeMeta</span> <span class="s">`json:",inline"`</span>
 <span class="n">metav1</span><span class="o">.</span><span class="n">ListMeta</span> <span class="s">`json:"metadata"`</span>
 
 <span class="n">Items</span> <span class="p">[]</span><span class="n">Network</span> <span class="s">`json:"items"`</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åœ¨ä¸Šé¢è¿™éƒ¨åˆ†ä»£ç é‡Œï¼Œä½ å¯ä»¥çœ‹åˆ° Network ç±»å‹å®šä¹‰æ–¹æ³•è·Ÿæ ‡å‡†çš„ Kubernetes å¯¹è±¡ä¸€æ ·ï¼Œéƒ½åŒ…æ‹¬äº† TypeMetaï¼ˆAPI å…ƒæ•°æ®ï¼‰å’Œ ObjectMetaï¼ˆå¯¹è±¡å…ƒæ•°æ®ï¼‰å­—æ®µã€‚è€Œå…¶ä¸­çš„ Spec å­—æ®µï¼Œå°±æ˜¯éœ€è¦æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„éƒ¨åˆ†ã€‚æ‰€ä»¥ï¼Œåœ¨ networkspec é‡Œï¼Œæˆ‘å®šä¹‰äº† Cidr å’Œ Gateway ä¸¤ä¸ªå­—æ®µã€‚</p>

<p>æ­¤å¤–ï¼Œé™¤äº†å®šä¹‰ Network ç±»å‹ï¼Œä½ è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ª NetworkList ç±»å‹ï¼Œç”¨æ¥æè¿°ä¸€ç»„ Network å¯¹è±¡åº”è¯¥åŒ…æ‹¬å“ªäº›å­—æ®µã€‚ä¹‹æ‰€ä»¥éœ€è¦è¿™æ ·ä¸€ä¸ªç±»å‹ï¼Œæ˜¯å› ä¸ºåœ¨ Kubernetes ä¸­ï¼Œè·å–æ‰€æœ‰ X å¯¹è±¡çš„ List() æ–¹æ³•ï¼Œè¿”å›å€¼éƒ½æ˜¯List ç±»å‹ï¼Œè€Œä¸æ˜¯ X ç±»å‹çš„æ•°ç»„ã€‚è¿™æ˜¯ä¸ä¸€æ ·çš„ã€‚åŒæ ·åœ°ï¼Œåœ¨ Network å’Œ NetworkList ç±»å‹ä¸Šï¼Œä¹Ÿæœ‰ä»£ç ç”Ÿæˆæ³¨é‡Šã€‚å…¶ä¸­ï¼Œ+genclient çš„æ„æ€æ˜¯ï¼šè¯·ä¸ºä¸‹é¢è¿™ä¸ª API èµ„æºç±»å‹ç”Ÿæˆå¯¹åº”çš„ Client ä»£ç .</p>

<p>è€Œ +genclient:noStatus çš„æ„æ€æ˜¯ï¼šè¿™ä¸ª API èµ„æºç±»å‹å®šä¹‰é‡Œï¼Œæ²¡æœ‰ Status å­—æ®µã€‚å¦åˆ™ï¼Œç”Ÿæˆçš„ Client å°±ä¼šè‡ªåŠ¨å¸¦ä¸Š UpdateStatus æ–¹æ³•ã€‚</p>

<p>å¦‚æœä½ çš„ç±»å‹å®šä¹‰åŒ…æ‹¬äº† Status å­—æ®µçš„è¯ï¼Œå°±ä¸éœ€è¦è¿™å¥ +genclient:noStatus æ³¨é‡Šäº†ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// +genclient</span>
<span class="c">// Network is a specification for a Network resource</span>
<span class="k">type</span> <span class="n">Network</span> <span class="k">struct</span> <span class="p">{</span>
 <span class="n">metav1</span><span class="o">.</span><span class="n">TypeMeta</span>   <span class="s">`json:",inline"`</span>
 <span class="n">metav1</span><span class="o">.</span><span class="n">ObjectMeta</span> <span class="s">`json:"metadata,omitempty"`</span>
 
 <span class="n">Spec</span>   <span class="n">NetworkSpec</span>   <span class="s">`json:"spec"`</span>
 <span class="n">Status</span> <span class="n">NetworkStatus</span> <span class="s">`json:"status"`</span>
<span class="p">}</span>
</code></pre></div></div>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ+genclient åªéœ€è¦å†™åœ¨ Network ç±»å‹ä¸Šï¼Œè€Œä¸ç”¨å†™åœ¨ NetworkList ä¸Šã€‚å› ä¸º NetworkList åªæ˜¯ä¸€ä¸ªè¿”å›å€¼ç±»å‹ï¼ŒNetwork æ‰æ˜¯â€œä¸»ç±»å‹â€ã€‚è€Œç”±äºæˆ‘åœ¨ Global Tags é‡Œå·²ç»å®šä¹‰äº†ä¸ºæ‰€æœ‰ç±»å‹ç”Ÿæˆ DeepCopy æ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸éœ€è¦å†æ˜¾å¼åœ°åŠ ä¸Š +k8s:deepcopy-gen=true äº†ã€‚å½“ç„¶ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ä½ å¯ä»¥ç”¨ +k8s:deepcopy-gen=false æ¥é˜»æ­¢ä¸ºæŸäº›ç±»å‹ç”Ÿæˆ DeepCopyã€‚</p>

<p>ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œåœ¨è¿™ä¸¤ä¸ªç±»å‹ä¸Šé¢è¿˜æœ‰ä¸€å¥+k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Objectçš„æ³¨é‡Šã€‚å®ƒçš„æ„æ€æ˜¯ï¼Œè¯·åœ¨ç”Ÿæˆ DeepCopy çš„æ—¶å€™ï¼Œå®ç° Kubernetes æä¾›çš„ runtime.Object æ¥å£ã€‚å¦åˆ™ï¼Œåœ¨æŸäº›ç‰ˆæœ¬çš„ Kubernetes é‡Œï¼Œä½ çš„è¿™ä¸ªç±»å‹å®šä¹‰ä¼šå‡ºç°ç¼–è¯‘é”™è¯¯ã€‚è¿™æ˜¯ä¸€ä¸ªå›ºå®šçš„æ“ä½œï¼Œè®°ä½å³å¯ã€‚ä¸è¿‡ï¼Œä½ æˆ–è®¸ä¼šæœ‰è¿™æ ·çš„é¡¾è™‘ï¼šè¿™äº›ä»£ç ç”Ÿæˆæ³¨é‡Šè¿™ä¹ˆçµæ´»ï¼Œæˆ‘è¯¥æ€ä¹ˆæŒæ¡å‘¢ï¼Ÿå…¶å®ï¼Œä¸Šé¢æˆ‘æ‰€è®²è¿°çš„å†…å®¹ï¼Œå·²ç»è¶³ä»¥åº”å¯¹ 99% çš„åœºæ™¯äº†ã€‚å½“ç„¶ï¼Œå¦‚æœä½ å¯¹ä»£ç ç”Ÿæˆæ„Ÿå…´è¶£çš„è¯ï¼Œæˆ‘æ¨èä½ é˜…è¯»è¿™ç¯‡åšå®¢ï¼Œå®ƒè¯¦ç»†åœ°ä»‹ç»äº† Kubernetes çš„ä»£ç ç”Ÿæˆè¯­æ³•ã€‚</p>

<p>æœ€åï¼Œæˆ‘éœ€è¦å†ç¼–å†™çš„ä¸€ä¸ª pkg/apis/cloudteam/v1/register.go æ–‡ä»¶ã€‚</p>

<p>åœ¨å‰é¢å¯¹ APIServer å·¥ä½œåŸç†çš„è®²è§£ä¸­ï¼Œæˆ‘å·²ç»æåˆ°ï¼Œâ€œregistryâ€çš„ä½œç”¨å°±æ˜¯æ³¨å†Œä¸€ä¸ªç±»å‹ï¼ˆTypeï¼‰ç»™ APIServerã€‚å…¶ä¸­ï¼ŒNetwork èµ„æºç±»å‹åœ¨æœåŠ¡å™¨ç«¯çš„æ³¨å†Œçš„å·¥ä½œï¼ŒAPIServer ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å®Œæˆã€‚ä½†ä¸ä¹‹å¯¹åº”çš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è®©å®¢æˆ·ç«¯ä¹Ÿèƒ½â€œçŸ¥é“â€Network èµ„æºç±»å‹çš„å®šä¹‰ã€‚è¿™å°±éœ€è¦æˆ‘ä»¬åœ¨é¡¹ç›®é‡Œæ·»åŠ ä¸€ä¸ª register.go æ–‡ä»¶ã€‚å®ƒæœ€ä¸»è¦çš„åŠŸèƒ½ï¼Œå°±æ˜¯å®šä¹‰äº†å¦‚ä¸‹æ‰€ç¤ºçš„ addKnownTypes() æ–¹æ³•ï¼š</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// addKnownTypes adds our types to the API scheme by registering</span>
<span class="c">// Network and NetworkList</span>
<span class="k">func</span> <span class="n">addKnownTypes</span><span class="p">(</span><span class="n">scheme</span> <span class="o">*</span><span class="n">runtime</span><span class="o">.</span><span class="n">Scheme</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="n">scheme</span><span class="o">.</span><span class="n">AddKnownTypes</span><span class="p">(</span>
		<span class="n">SchemeGroupVersion</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">Network</span><span class="p">{},</span>
		<span class="o">&amp;</span><span class="n">NetworkList</span><span class="p">{},</span>
	<span class="p">)</span>

	<span class="c">// register the type in the scheme</span>
	<span class="n">metav1</span><span class="o">.</span><span class="n">AddToGroupVersion</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">SchemeGroupVersion</span><span class="p">)</span>
	<span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="ä»ç”³æ˜å¼apiè¯´èµ·">ä»ç”³æ˜å¼APIè¯´èµ·</h3>

<p>æœŸæœ›çŠ¶æ€ï¼Œå®é™…çŠ¶æ€</p>

<p>æœŸæœ›çŠ¶æ€ï¼šéœ€è¦é€šè¿‡kube-apiserveræŸ¥è¯¢è®°å½•åœ¨etcdé‡Œæ•°æ®è·å–åˆ°</p>

<p>å®é™…çŠ¶æ€ï¼šéœ€è¦è°ƒç”¨é›†ç¾¤ï¼ˆèµ„æºï¼‰è¿è¡ŒçŠ¶æ€çš„æŸ¥è¯¢æ¥å£è·å–ï¼ˆå¦‚ï¼šå¦‚æœkubeletè·å–podæ•°é‡å’ŒçŠ¶æ€ï¼‰</p>

<p>æ§åˆ¶å¾ªç¯çš„ä½œç”¨å°±æ˜¯ï¼Œå¯¹æ¯”å®é™…çŠ¶æ€æ˜¯å¦ä¸ºæœŸæœ›çŠ¶æ€ï¼Œå¦‚æœä¸æ˜¯ã€‚åˆ™è¿›è¡Œè°ƒè°ï¼ˆReconcileï¼‰</p>

<p>ä¸‹é¢ï¼Œä»è·å–æœŸæœ›çŠ¶æ€ï¼Œè·å–å®é™…çŠ¶æ€ï¼Œå’Œè°ƒè°ä¸‰ä¸ªæ­¥éª¤è§£é‡Šè‡ªå®šä¹‰æ§åˆ¶å™¨çš„åŸç†</p>

<p><img src="/Users/zhangchao/neteric.github.io/_posts/32e545dcd4664a3f36e95af83b571ec3.png" alt="img" /></p>

<h4 id="ä¸€è·å–æœŸæœ›çŠ¶æ€çš„è¿‡ç¨‹">ä¸€ã€è·å–æœŸæœ›çŠ¶æ€çš„è¿‡ç¨‹</h4>

<p>å¯¹è±¡çš„æœŸæœ›çŠ¶æ€å­˜å‚¨åœ¨etcdæ•°æ®åº“ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡è°ƒç”¨kubernetesçš„apiæ¥å£æ¥è·å–å¯¹è±¡çš„æœŸæœ›çŠ¶æ€ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªè®¾è®¡é—®é¢˜ï¼šä¸€ä¸ªAPIå¯¹è±¡å°±å¯¹åº”ä¸€ä¸ªæ§åˆ¶å¾ªç¯ï¼Œä¸€ä¸ªæ§åˆ¶å¾ªç¯ä¼šå‘¨æœŸçš„é«˜é¢‘çš„å¯¹apiæ¥å£è¿›è¡Œè°ƒç”¨ï¼Œé‚£ä¹ˆå½“APIå¯¹è±¡çš„æ•°é‡å¤šèµ·æ¥åï¼Œk8sæœ¬èº«è¿è¡Œèµ·æ¥å°±ä¼šå¯¹APIäº§ç”Ÿå·¨å¤§çš„å‹åŠ›ï¼Œæ›´åˆ«è¯´è¿˜æœ‰ä¸‰æ–¹ç³»ç»Ÿä¼šè°ƒç”¨k8sçš„apiï¼Œè¿™ç§è®¾è®¡æ˜¾ç„¶æœ‰é—®é¢˜ã€‚</p>

<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œk8s å¼•å…¥äº†ä¸€ä¸ªç²¾å¿ƒè®¾è®¡çš„æ¨¡å—ï¼šInformer</p>

<p>Informer ä¸ API å¯¹è±¡æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œæ‰€ä»¥æˆ‘ä¼ é€’ç»™è‡ªå®šä¹‰æ§åˆ¶å™¨çš„ï¼Œæ­£æ˜¯ä¸€ä¸ª Network å¯¹è±¡çš„ Informerï¼ˆNetwork Informerï¼‰ã€‚ä¸çŸ¥ä½ æ˜¯å¦å·²ç»æ³¨æ„åˆ°ï¼Œæˆ‘åœ¨åˆ›å»ºè¿™ä¸ª Informer å·¥å‚çš„æ—¶å€™ï¼Œéœ€è¦ç»™å®ƒä¼ é€’ä¸€ä¸ª networkClientã€‚äº‹å®ä¸Šï¼ŒNetwork Informer æ­£æ˜¯ä½¿ç”¨è¿™ä¸ª networkClientï¼Œè·Ÿ APIServer å»ºç«‹äº†è¿æ¥ã€‚</p>

<p>ä¸è¿‡ï¼ŒçœŸæ­£è´Ÿè´£ç»´æŠ¤è¿™ä¸ªè¿æ¥çš„ï¼Œåˆ™æ˜¯ Informer æ‰€ä½¿ç”¨çš„ Reflector åŒ…ã€‚æ›´å…·ä½“åœ°è¯´ï¼ŒReflector ä½¿ç”¨çš„æ˜¯ä¸€ç§å«ä½œ ListAndWatch çš„æ–¹æ³•ï¼Œæ¥â€œè·å–â€å¹¶â€œç›‘å¬â€è¿™äº› Network å¯¹è±¡å®ä¾‹çš„å˜åŒ–ã€‚åœ¨ ListAndWatch æœºåˆ¶ä¸‹ï¼Œä¸€æ—¦ APIServer ç«¯æœ‰æ–°çš„ Network å®ä¾‹è¢«åˆ›å»ºã€åˆ é™¤æˆ–è€…æ›´æ–°ï¼ŒReflector éƒ½ä¼šæ”¶åˆ°â€œäº‹ä»¶é€šçŸ¥â€ã€‚è¿™æ—¶ï¼Œ<strong>è¯¥äº‹ä»¶åŠå®ƒå¯¹åº”çš„ API å¯¹è±¡è¿™ä¸ªç»„åˆï¼Œå°±è¢«ç§°ä¸ºå¢é‡ï¼ˆDeltaï¼‰</strong>ï¼Œå®ƒä¼šè¢«æ”¾è¿›ä¸€ä¸ª Delta FIFO Queueï¼ˆå³ï¼šå¢é‡å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—ï¼‰ä¸­ã€‚è€Œå¦ä¸€æ–¹é¢ï¼ŒInforme ä¼šä¸æ–­åœ°ä»è¿™ä¸ª Delta FIFO Queue é‡Œè¯»å–ï¼ˆPopï¼‰å¢é‡ã€‚æ¯æ‹¿åˆ°ä¸€ä¸ªå¢é‡ï¼ŒInformer å°±ä¼šåˆ¤æ–­è¿™ä¸ªå¢é‡é‡Œçš„äº‹ä»¶ç±»å‹ï¼Œç„¶ååˆ›å»ºæˆ–è€…æ›´æ–°æœ¬åœ°å¯¹è±¡çš„ç¼“å­˜ã€‚è¿™ä¸ªç¼“å­˜ï¼Œåœ¨ Kubernetes é‡Œä¸€èˆ¬è¢«å«ä½œ Storeã€‚æ¯”å¦‚ï¼Œå¦‚æœäº‹ä»¶ç±»å‹æ˜¯ Addedï¼ˆæ·»åŠ å¯¹è±¡ï¼‰ï¼Œé‚£ä¹ˆ Informer å°±ä¼šé€šè¿‡ä¸€ä¸ªå«ä½œ Indexer çš„åº“æŠŠè¿™ä¸ªå¢é‡é‡Œçš„ API å¯¹è±¡ä¿å­˜åœ¨æœ¬åœ°ç¼“å­˜ä¸­ï¼Œå¹¶ä¸ºå®ƒåˆ›å»ºç´¢å¼•ã€‚ç›¸ååœ°ï¼Œå¦‚æœå¢é‡çš„äº‹ä»¶ç±»å‹æ˜¯ Deletedï¼ˆåˆ é™¤å¯¹è±¡ï¼‰ï¼Œé‚£ä¹ˆ Informer å°±ä¼šä»æœ¬åœ°ç¼“å­˜ä¸­åˆ é™¤è¿™ä¸ªå¯¹è±¡ã€‚è¿™ä¸ªåŒæ­¥æœ¬åœ°ç¼“å­˜çš„å·¥ä½œï¼Œæ˜¯ Informer çš„ç¬¬ä¸€ä¸ªèŒè´£ï¼Œä¹Ÿæ˜¯å®ƒæœ€é‡è¦çš„èŒè´£ã€‚è€Œ Informer çš„ç¬¬äºŒä¸ªèŒè´£ï¼Œåˆ™æ˜¯æ ¹æ®è¿™äº›äº‹ä»¶çš„ç±»å‹ï¼Œè§¦å‘äº‹å…ˆæ³¨å†Œå¥½çš„ ResourceEventHandlerã€‚è¿™äº› Handlerï¼Œéœ€è¦åœ¨åˆ›å»ºæ§åˆ¶å™¨çš„æ—¶å€™æ³¨å†Œç»™å®ƒå¯¹åº”çš„ Informerã€‚</p>

<p>Informerçš„ä¸‰ä¸ªèŒè´£ï¼š</p>

<ol>
  <li>watch-list å¯¹è±¡çš„å˜åŒ–</li>
  <li>ä¸ºäº†é¿å…é¢‘ç¹çš„è°ƒç”¨apiï¼Œå»ºç«‹æœ¬åœ°ç¼“å­˜store</li>
  <li>æ ¹æ®å¯¹è±¡çš„å˜åŒ–äº‹ä»¶çš„ç±»å‹ï¼Œè§¦å‘äº‹å…ˆæ³¨å†Œå¥½çš„ Handler</li>
</ol>

<p>æˆ‘å‰é¢åœ¨ main å‡½æ•°é‡Œåˆ›å»ºäº†ä¸¤ä¸ª clientï¼ˆkubeclientset å’Œ networkclientsetï¼‰ï¼Œç„¶ååœ¨è¿™æ®µä»£ç é‡Œï¼Œä½¿ç”¨è¿™ä¸¤ä¸ª client å’Œå‰é¢åˆ›å»ºçš„ Informerï¼Œåˆå§‹åŒ–äº†è‡ªå®šä¹‰æ§åˆ¶å™¨ã€‚</p>

<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨è¿™ä¸ªè‡ªå®šä¹‰æ§åˆ¶å™¨é‡Œï¼Œæˆ‘è¿˜è®¾ç½®äº†ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—ï¼ˆwork queueï¼‰ï¼Œå®ƒæ­£æ˜¯å¤„äºç¤ºæ„å›¾ä¸­é—´ä½ç½®çš„ WorkQueueã€‚è¿™ä¸ªå·¥ä½œé˜Ÿåˆ—çš„ä½œç”¨æ˜¯ï¼Œè´Ÿè´£åŒæ­¥ Informer å’Œæ§åˆ¶å¾ªç¯ä¹‹é—´çš„æ•°æ®ã€‚å®é™…ä¸Šï¼ŒKubernetes é¡¹ç›®ä¸ºæˆ‘ä»¬æä¾›äº†å¾ˆå¤šä¸ªå·¥ä½œé˜Ÿåˆ—çš„å®ç°ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©åˆé€‚çš„åº“ç›´æ¥ä½¿ç”¨ã€‚ç„¶åï¼Œæˆ‘ä¸º networkInformer æ³¨å†Œäº†ä¸‰ä¸ª Handlerï¼ˆAddFuncã€UpdateFunc å’Œ DeleteFuncï¼‰ï¼Œåˆ†åˆ«å¯¹åº” API å¯¹è±¡çš„â€œæ·»åŠ â€â€œæ›´æ–°â€å’Œâ€œåˆ é™¤â€äº‹ä»¶ã€‚è€Œå…·ä½“çš„å¤„ç†æ“ä½œï¼Œéƒ½æ˜¯å°†è¯¥äº‹ä»¶å¯¹åº”çš„ API å¯¹è±¡åŠ å…¥åˆ°å·¥ä½œé˜Ÿåˆ—ä¸­ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®é™…å…¥é˜Ÿçš„å¹¶ä¸æ˜¯ API å¯¹è±¡æœ¬èº«ï¼Œè€Œæ˜¯å®ƒä»¬çš„ Keyï¼Œå³ï¼šè¯¥ API å¯¹è±¡çš„/ã€‚è€Œæˆ‘ä»¬åé¢å³å°†ç¼–å†™çš„æ§åˆ¶å¾ªç¯ï¼Œåˆ™ä¼šä¸æ–­åœ°ä»è¿™ä¸ªå·¥ä½œé˜Ÿåˆ—é‡Œæ‹¿åˆ°è¿™äº› Keyï¼Œç„¶åå¼€å§‹æ‰§è¡ŒçœŸæ­£çš„æ§åˆ¶é€»è¾‘ã€‚ç»¼åˆä¸Šé¢çš„è®²è¿°ï¼Œä½ ç°åœ¨åº”è¯¥å°±èƒ½æ˜ç™½ï¼Œæ‰€è°“ Informerï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¸¦æœ‰æœ¬åœ°ç¼“å­˜å’Œç´¢å¼•æœºåˆ¶çš„ã€å¯ä»¥æ³¨å†Œ EventHandler çš„ clientã€‚å®ƒæ˜¯è‡ªå®šä¹‰æ§åˆ¶å™¨è·Ÿ APIServer è¿›è¡Œæ•°æ®åŒæ­¥çš„é‡è¦ç»„ä»¶ã€‚æ›´å…·ä½“åœ°è¯´ï¼ŒInformer é€šè¿‡ä¸€ç§å«ä½œ ListAndWatch çš„æ–¹æ³•ï¼ŒæŠŠ APIServer ä¸­çš„ API å¯¹è±¡ç¼“å­˜åœ¨äº†æœ¬åœ°ï¼Œå¹¶è´Ÿè´£æ›´æ–°å’Œç»´æŠ¤è¿™ä¸ªç¼“å­˜ã€‚å…¶ä¸­ï¼ŒListAndWatch æ–¹æ³•çš„å«ä¹‰æ˜¯ï¼šé¦–å…ˆï¼Œé€šè¿‡ APIServer çš„ LIST APIâ€œè·å–â€æ‰€æœ‰æœ€æ–°ç‰ˆæœ¬çš„ API å¯¹è±¡ï¼›ç„¶åï¼Œå†é€šè¿‡ WATCH API æ¥â€œç›‘å¬â€æ‰€æœ‰è¿™äº› API å¯¹è±¡çš„å˜åŒ–ã€‚è€Œé€šè¿‡ç›‘å¬åˆ°çš„äº‹ä»¶å˜åŒ–ï¼ŒInformer å°±å¯ä»¥å®æ—¶åœ°æ›´æ–°æœ¬åœ°ç¼“å­˜ï¼Œå¹¶ä¸”è°ƒç”¨è¿™äº›äº‹ä»¶å¯¹åº”çš„ EventHandler äº†ã€‚æ­¤å¤–ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ¯ç»è¿‡ resyncPeriod æŒ‡å®šçš„æ—¶é—´ï¼ŒInformer ç»´æŠ¤çš„æœ¬åœ°ç¼“å­˜ï¼Œéƒ½ä¼šä½¿ç”¨æœ€è¿‘ä¸€æ¬¡ LIST è¿”å›çš„ç»“æœå¼ºåˆ¶æ›´æ–°ä¸€æ¬¡ï¼Œä»è€Œä¿è¯ç¼“å­˜çš„æœ‰æ•ˆæ€§ã€‚åœ¨ Kubernetes ä¸­ï¼Œè¿™ä¸ªç¼“å­˜å¼ºåˆ¶æ›´æ–°çš„æ“ä½œå°±å«ä½œï¼šresyncã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªå®šæ—¶ resync æ“ä½œï¼Œä¹Ÿä¼šè§¦å‘ Informer æ³¨å†Œçš„â€œæ›´æ–°â€äº‹ä»¶ã€‚ä½†æ­¤æ—¶ï¼Œè¿™ä¸ªâ€œæ›´æ–°â€äº‹ä»¶å¯¹åº”çš„ Network å¯¹è±¡å®é™…ä¸Šå¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œå³ï¼šæ–°ã€æ—§ä¸¤ä¸ª Network å¯¹è±¡çš„ ResourceVersion æ˜¯ä¸€æ ·çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒInformer å°±ä¸éœ€è¦å¯¹è¿™ä¸ªæ›´æ–°äº‹ä»¶å†åšè¿›ä¸€æ­¥çš„å¤„ç†äº†ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘åœ¨ä¸Šé¢çš„ UpdateFunc æ–¹æ³•é‡Œï¼Œå…ˆåˆ¤æ–­äº†ä¸€ä¸‹æ–°ã€æ—§ä¸¤ä¸ª Network å¯¹è±¡çš„ç‰ˆæœ¬ï¼ˆResourceVersionï¼‰æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œç„¶åæ‰å¼€å§‹è¿›è¡Œçš„å…¥é˜Ÿæ“ä½œã€‚ä»¥ä¸Šï¼Œå°±æ˜¯ Kubernetes ä¸­çš„ Informer åº“çš„å·¥ä½œåŸç†äº†ã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥åˆ°äº†ç¤ºæ„å›¾ä¸­æœ€åé¢çš„æ§åˆ¶å¾ªç¯ï¼ˆControl Loopï¼‰éƒ¨åˆ†ï¼Œä¹Ÿæ­£æ˜¯æˆ‘åœ¨ main å‡½æ•°æœ€åè°ƒç”¨ controller.Run() å¯åŠ¨çš„â€œæ§åˆ¶å¾ªç¯â€ã€‚å®ƒçš„ä¸»è¦å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå¯åŠ¨æ§åˆ¶å¾ªç¯çš„é€»è¾‘éå¸¸ç®€å•ï¼šé¦–å…ˆï¼Œç­‰å¾… Informer å®Œæˆä¸€æ¬¡æœ¬åœ°ç¼“å­˜çš„æ•°æ®åŒæ­¥æ“ä½œï¼›ç„¶åï¼Œç›´æ¥é€šè¿‡ goroutine å¯åŠ¨ä¸€ä¸ªï¼ˆæˆ–è€…å¹¶å‘å¯åŠ¨å¤šä¸ªï¼‰â€œæ— é™å¾ªç¯â€çš„ä»»åŠ¡ã€‚</p>

<p>è€Œè¿™ä¸ªâ€œæ— é™å¾ªç¯â€ä»»åŠ¡çš„æ¯ä¸€ä¸ªå¾ªç¯å‘¨æœŸï¼Œæ‰§è¡Œçš„æ­£æ˜¯æˆ‘ä»¬çœŸæ­£å…³å¿ƒçš„ä¸šåŠ¡é€»è¾‘ã€‚</p>

<p>æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥ç¼–å†™è¿™ä¸ªè‡ªå®šä¹‰æ§åˆ¶å™¨çš„ä¸šåŠ¡é€»è¾‘ï¼Œå®ƒçš„ä¸»è¦å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// runWorker is a long-running function that will continually call the</span>
<span class="c">// processNextWorkItem function in order to read and process a message on the</span>
<span class="c">// workqueue.</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Controller</span><span class="p">)</span> <span class="n">runWorker</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">for</span> <span class="n">c</span><span class="o">.</span><span class="n">processNextWorkItem</span><span class="p">()</span> <span class="p">{</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c">// processNextWorkItem will read a single work item off the workqueue and</span>
<span class="c">// attempt to process it, by calling the syncHandler.</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Controller</span><span class="p">)</span> <span class="n">processNextWorkItem</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="n">obj</span><span class="p">,</span> <span class="n">shutdown</span> <span class="o">:=</span> <span class="n">c</span><span class="o">.</span><span class="n">workqueue</span><span class="o">.</span><span class="n">Get</span><span class="p">()</span>

	<span class="k">if</span> <span class="n">shutdown</span> <span class="p">{</span>
		<span class="k">return</span> <span class="no">false</span>
	<span class="p">}</span>

	<span class="c">// We wrap this block in a func so we can defer c.workqueue.Done.</span>
	<span class="n">err</span> <span class="o">:=</span> <span class="k">func</span><span class="p">(</span><span class="n">obj</span> <span class="k">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="c">// We call Done here so the workqueue knows we have finished</span>
		<span class="c">// processing this item. We also must remember to call Forget if we</span>
		<span class="c">// do not want this work item being re-queued. For example, we do</span>
		<span class="c">// not call Forget if a transient error occurs, instead the item is</span>
		<span class="c">// put back on the workqueue and attempted again after a back-off</span>
		<span class="c">// period.</span>
		<span class="k">defer</span> <span class="n">c</span><span class="o">.</span><span class="n">workqueue</span><span class="o">.</span><span class="n">Done</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
		<span class="k">var</span> <span class="n">key</span> <span class="kt">string</span>
		<span class="k">var</span> <span class="n">ok</span> <span class="kt">bool</span>
		<span class="c">// We expect strings to come off the workqueue. These are of the</span>
		<span class="c">// form namespace/name. We do this as the delayed nature of the</span>
		<span class="c">// workqueue means the items in the informer cache may actually be</span>
		<span class="c">// more up to date that when the item was initially put onto the</span>
		<span class="c">// workqueue.</span>
		<span class="k">if</span> <span class="n">key</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="p">(</span><span class="kt">string</span><span class="p">);</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
			<span class="c">// As the item in the workqueue is actually invalid, we call</span>
			<span class="c">// Forget here else we'd go into a loop of attempting to</span>
			<span class="c">// process a work item that is invalid.</span>
			<span class="n">c</span><span class="o">.</span><span class="n">workqueue</span><span class="o">.</span><span class="n">Forget</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
			<span class="n">runtime</span><span class="o">.</span><span class="n">HandleError</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"expected string in workqueue but got %#v"</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
			<span class="k">return</span> <span class="no">nil</span>
		<span class="p">}</span>
		<span class="c">// Run the syncHandler, passing it the namespace/name string of the</span>
		<span class="c">// Network resource to be synced.</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">c</span><span class="o">.</span><span class="n">syncHandler</span><span class="p">(</span><span class="n">key</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"error syncing '%s': %s"</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
		<span class="p">}</span>
		<span class="c">// Finally, if no error occurs we Forget this item so it does not</span>
		<span class="c">// get queued again until another change happens.</span>
		<span class="n">c</span><span class="o">.</span><span class="n">workqueue</span><span class="o">.</span><span class="n">Forget</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
		<span class="n">glog</span><span class="o">.</span><span class="n">Infof</span><span class="p">(</span><span class="s">"Successfully synced '%s'"</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
		<span class="k">return</span> <span class="no">nil</span>
	<span class="p">}(</span><span class="n">obj</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">.</span><span class="n">HandleError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="no">true</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="no">true</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ªæ‰§è¡Œå‘¨æœŸé‡Œï¼ˆprocessNextWorkItemï¼‰ï¼Œæˆ‘ä»¬é¦–å…ˆä»å·¥ä½œé˜Ÿåˆ—é‡Œå‡ºé˜Ÿï¼ˆworkqueue.Getï¼‰äº†ä¸€ä¸ªæˆå‘˜ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª Keyï¼ˆNetwork å¯¹è±¡çš„ï¼šnamespace/nameï¼‰ã€‚ç„¶åï¼Œåœ¨ syncHandler æ–¹æ³•ä¸­ï¼Œæˆ‘ä½¿ç”¨è¿™ä¸ª Keyï¼Œå°è¯•ä» Informer ç»´æŠ¤çš„ç¼“å­˜ä¸­æ‹¿åˆ°äº†å®ƒæ‰€å¯¹åº”çš„ Network å¯¹è±¡ã€‚å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä½¿ç”¨äº† networksLister æ¥å°è¯•è·å–è¿™ä¸ª Key å¯¹åº”çš„ Network å¯¹è±¡ã€‚è¿™ä¸ªæ“ä½œï¼Œå…¶å®å°±æ˜¯åœ¨è®¿é—®æœ¬åœ°ç¼“å­˜çš„ç´¢å¼•ã€‚å®é™…ä¸Šï¼Œåœ¨ Kubernetes çš„æºç ä¸­ï¼Œä½ ä¼šç»å¸¸çœ‹åˆ°æ§åˆ¶å™¨ä»å„ç§ Lister é‡Œè·å–å¯¹è±¡ï¼Œæ¯”å¦‚ï¼špodListerã€nodeLister ç­‰ç­‰ï¼Œå®ƒä»¬ä½¿ç”¨çš„éƒ½æ˜¯ Informer å’Œç¼“å­˜æœºåˆ¶ã€‚è€Œå¦‚æœæ§åˆ¶å¾ªç¯ä»ç¼“å­˜ä¸­æ‹¿ä¸åˆ°è¿™ä¸ªå¯¹è±¡ï¼ˆå³ï¼šnetworkLister è¿”å›äº† IsNotFound é”™è¯¯ï¼‰ï¼Œé‚£å°±æ„å‘³ç€è¿™ä¸ª Network å¯¹è±¡çš„ Key æ˜¯é€šè¿‡å‰é¢çš„â€œåˆ é™¤â€äº‹ä»¶æ·»åŠ è¿›å·¥ä½œé˜Ÿåˆ—çš„ã€‚æ‰€ä»¥ï¼Œå°½ç®¡é˜Ÿåˆ—é‡Œæœ‰è¿™ä¸ª Keyï¼Œä½†æ˜¯å¯¹åº”çš„ Network å¯¹è±¡å·²ç»è¢«åˆ é™¤äº†ã€‚è¿™æ—¶å€™ï¼Œæˆ‘å°±éœ€è¦è°ƒç”¨ Neutron çš„ APIï¼ŒæŠŠè¿™ä¸ª Key å¯¹åº”çš„ Neutron ç½‘ç»œä»çœŸå®çš„é›†ç¾¤é‡Œåˆ é™¤æ‰ã€‚è€Œå¦‚æœèƒ½å¤Ÿè·å–åˆ°å¯¹åº”çš„ Network å¯¹è±¡ï¼Œæˆ‘å°±å¯ä»¥æ‰§è¡Œæ§åˆ¶å™¨æ¨¡å¼é‡Œçš„å¯¹æ¯”â€œæœŸæœ›çŠ¶æ€â€å’Œâ€œå®é™…çŠ¶æ€â€çš„é€»è¾‘äº†ã€‚å…¶ä¸­ï¼Œè‡ªå®šä¹‰æ§åˆ¶å™¨â€œåƒè¾›ä¸‡è‹¦â€æ‹¿åˆ°çš„è¿™ä¸ª Network å¯¹è±¡ï¼Œæ­£æ˜¯ APIServer é‡Œä¿å­˜çš„â€œæœŸæœ›çŠ¶æ€â€ï¼Œå³ï¼šç”¨æˆ·é€šè¿‡ YAML æ–‡ä»¶æäº¤åˆ° APIServer é‡Œçš„ä¿¡æ¯ã€‚å½“ç„¶ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­é‡Œï¼Œå®ƒå·²ç»è¢« Informer ç¼“å­˜åœ¨äº†æœ¬åœ°ã€‚é‚£ä¹ˆï¼Œâ€œå®é™…çŠ¶æ€â€åˆä»å“ªé‡Œæ¥å‘¢ï¼Ÿå½“ç„¶æ˜¯æ¥è‡ªäºå®é™…çš„é›†ç¾¤äº†ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬çš„æ§åˆ¶å¾ªç¯éœ€è¦é€šè¿‡ Neutron API æ¥æŸ¥è¯¢å®é™…çš„ç½‘ç»œæƒ…å†µã€‚æ¯”å¦‚ï¼Œæˆ‘å¯ä»¥å…ˆé€šè¿‡ Neutron æ¥æŸ¥è¯¢è¿™ä¸ª Network å¯¹è±¡å¯¹åº”çš„çœŸå®ç½‘ç»œæ˜¯å¦å­˜åœ¨ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„â€œæœŸæœ›çŠ¶æ€â€ä¸â€œå®é™…çŠ¶æ€â€ä¸ä¸€è‡´çš„æƒ…å½¢ã€‚è¿™æ—¶ï¼Œæˆ‘å°±éœ€è¦ä½¿ç”¨è¿™ä¸ª Network å¯¹è±¡é‡Œçš„ä¿¡æ¯ï¼ˆæ¯”å¦‚ï¼šCIDR å’Œ Gatewayï¼‰ï¼Œè°ƒç”¨ Neutron API æ¥åˆ›å»ºçœŸå®çš„ç½‘ç»œã€‚å¦‚æœå­˜åœ¨ï¼Œé‚£ä¹ˆï¼Œæˆ‘å°±è¦è¯»å–è¿™ä¸ªçœŸå®ç½‘ç»œçš„ä¿¡æ¯ï¼Œåˆ¤æ–­å®ƒæ˜¯å¦è·Ÿ Network å¯¹è±¡é‡Œçš„ä¿¡æ¯ä¸€è‡´ï¼Œä»è€Œå†³å®šæˆ‘æ˜¯å¦è¦é€šè¿‡ Neutron æ¥æ›´æ–°è¿™ä¸ªå·²ç»å­˜åœ¨çš„çœŸå®ç½‘ç»œã€‚è¿™æ ·ï¼Œæˆ‘å°±é€šè¿‡å¯¹æ¯”â€œæœŸæœ›çŠ¶æ€â€å’Œâ€œå®é™…çŠ¶æ€â€çš„å·®å¼‚ï¼Œå®Œæˆäº†ä¸€æ¬¡è°ƒåï¼ˆReconcileï¼‰çš„è¿‡ç¨‹ã€‚</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// NewController returns a new network controller</span>
<span class="k">func</span> <span class="n">NewController</span><span class="p">(</span>
	<span class="n">kubeclientset</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">Interface</span><span class="p">,</span>
	<span class="n">networkclientset</span> <span class="n">clientset</span><span class="o">.</span><span class="n">Interface</span><span class="p">,</span>
	<span class="n">networkInformer</span> <span class="n">informers</span><span class="o">.</span><span class="n">NetworkInformer</span><span class="p">)</span> <span class="o">*</span><span class="n">Controller</span> <span class="p">{</span>

	<span class="c">// Create event broadcaster</span>
	<span class="c">// Add sample-controller types to the default Kubernetes Scheme so Events can be</span>
	<span class="c">// logged for sample-controller types.</span>
	<span class="n">utilruntime</span><span class="o">.</span><span class="n">Must</span><span class="p">(</span><span class="n">networkscheme</span><span class="o">.</span><span class="n">AddToScheme</span><span class="p">(</span><span class="n">scheme</span><span class="o">.</span><span class="n">Scheme</span><span class="p">))</span>
	<span class="n">glog</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="m">4</span><span class="p">)</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"Creating event broadcaster"</span><span class="p">)</span>
	<span class="n">eventBroadcaster</span> <span class="o">:=</span> <span class="n">record</span><span class="o">.</span><span class="n">NewBroadcaster</span><span class="p">()</span>
	<span class="n">eventBroadcaster</span><span class="o">.</span><span class="n">StartLogging</span><span class="p">(</span><span class="n">glog</span><span class="o">.</span><span class="n">Infof</span><span class="p">)</span>
	<span class="n">eventBroadcaster</span><span class="o">.</span><span class="n">StartRecordingToSink</span><span class="p">(</span><span class="o">&amp;</span><span class="n">typedcorev1</span><span class="o">.</span><span class="n">EventSinkImpl</span><span class="p">{</span><span class="n">Interface</span><span class="o">:</span> <span class="n">kubeclientset</span><span class="o">.</span><span class="n">CoreV1</span><span class="p">()</span><span class="o">.</span><span class="n">Events</span><span class="p">(</span><span class="s">""</span><span class="p">)})</span>
	<span class="n">recorder</span> <span class="o">:=</span> <span class="n">eventBroadcaster</span><span class="o">.</span><span class="n">NewRecorder</span><span class="p">(</span><span class="n">scheme</span><span class="o">.</span><span class="n">Scheme</span><span class="p">,</span> <span class="n">corev1</span><span class="o">.</span><span class="n">EventSource</span><span class="p">{</span><span class="n">Component</span><span class="o">:</span> <span class="n">controllerAgentName</span><span class="p">})</span>

	<span class="n">controller</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Controller</span><span class="p">{</span>
		<span class="n">kubeclientset</span><span class="o">:</span>    <span class="n">kubeclientset</span><span class="p">,</span>
		<span class="n">networkclientset</span><span class="o">:</span> <span class="n">networkclientset</span><span class="p">,</span>
		<span class="n">networksLister</span><span class="o">:</span>   <span class="n">networkInformer</span><span class="o">.</span><span class="n">Lister</span><span class="p">(),</span>
		<span class="n">networksSynced</span><span class="o">:</span>   <span class="n">networkInformer</span><span class="o">.</span><span class="n">Informer</span><span class="p">()</span><span class="o">.</span><span class="n">HasSynced</span><span class="p">,</span>
		<span class="n">workqueue</span><span class="o">:</span>        <span class="n">workqueue</span><span class="o">.</span><span class="n">NewNamedRateLimitingQueue</span><span class="p">(</span><span class="n">workqueue</span><span class="o">.</span><span class="n">DefaultControllerRateLimiter</span><span class="p">(),</span> <span class="s">"Networks"</span><span class="p">),</span>
		<span class="n">recorder</span><span class="o">:</span>         <span class="n">recorder</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="n">glog</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"Setting up event handlers"</span><span class="p">)</span>
	<span class="c">// Set up an event handler for when Network resources change</span>
	<span class="n">networkInformer</span><span class="o">.</span><span class="n">Informer</span><span class="p">()</span><span class="o">.</span><span class="n">AddEventHandler</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">ResourceEventHandlerFuncs</span><span class="p">{</span>
		<span class="n">AddFunc</span><span class="o">:</span> <span class="n">controller</span><span class="o">.</span><span class="n">enqueueNetwork</span><span class="p">,</span>
		<span class="n">UpdateFunc</span><span class="o">:</span> <span class="k">func</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="nb">new</span> <span class="k">interface</span><span class="p">{})</span> <span class="p">{</span>
			<span class="n">oldNetwork</span> <span class="o">:=</span> <span class="n">old</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">samplecrdv1</span><span class="o">.</span><span class="n">Network</span><span class="p">)</span>
			<span class="n">newNetwork</span> <span class="o">:=</span> <span class="nb">new</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">samplecrdv1</span><span class="o">.</span><span class="n">Network</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">oldNetwork</span><span class="o">.</span><span class="n">ResourceVersion</span> <span class="o">==</span> <span class="n">newNetwork</span><span class="o">.</span><span class="n">ResourceVersion</span> <span class="p">{</span>
				<span class="c">// Periodic resync will send update events for all known Networks.</span>
				<span class="c">// Two different versions of the same Network will always have different RVs.</span>
				<span class="k">return</span>
			<span class="p">}</span>
			<span class="n">controller</span><span class="o">.</span><span class="n">enqueueNetwork</span><span class="p">(</span><span class="nb">new</span><span class="p">)</span>
		<span class="p">},</span>
		<span class="n">DeleteFunc</span><span class="o">:</span> <span class="n">controller</span><span class="o">.</span><span class="n">enqueueNetworkForDelete</span><span class="p">,</span>
	<span class="p">})</span>

	<span class="k">return</span> <span class="n">controller</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">flag</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>

	<span class="c">// set up signals so we handle the first shutdown signal gracefully</span>
	<span class="n">stopCh</span> <span class="o">:=</span> <span class="n">signals</span><span class="o">.</span><span class="n">SetupSignalHandler</span><span class="p">()</span>

	<span class="n">cfg</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">clientcmd</span><span class="o">.</span><span class="n">BuildConfigFromFlags</span><span class="p">(</span><span class="n">masterURL</span><span class="p">,</span> <span class="n">kubeconfig</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">glog</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Error building kubeconfig: %s"</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
	<span class="p">}</span>

	<span class="n">kubeClient</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">NewForConfig</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">glog</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Error building kubernetes clientset: %s"</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
	<span class="p">}</span>

	<span class="n">networkClient</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">clientset</span><span class="o">.</span><span class="n">NewForConfig</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">glog</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Error building example clientset: %s"</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
	<span class="p">}</span>

	<span class="n">networkInformerFactory</span> <span class="o">:=</span> <span class="n">informers</span><span class="o">.</span><span class="n">NewSharedInformerFactory</span><span class="p">(</span><span class="n">networkClient</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="o">*</span><span class="m">30</span><span class="p">)</span>

	<span class="n">controller</span> <span class="o">:=</span> <span class="n">NewController</span><span class="p">(</span><span class="n">kubeClient</span><span class="p">,</span> <span class="n">networkClient</span><span class="p">,</span>
		<span class="n">networkInformerFactory</span><span class="o">.</span><span class="n">Samplecrd</span><span class="p">()</span><span class="o">.</span><span class="n">V1</span><span class="p">()</span><span class="o">.</span><span class="n">Networks</span><span class="p">())</span>

	<span class="k">go</span> <span class="n">networkInformerFactory</span><span class="o">.</span><span class="n">Start</span><span class="p">(</span><span class="n">stopCh</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">err</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="n">stopCh</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">glog</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Error running controller: %s"</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
	<span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ª main å‡½æ•°ä¸»è¦é€šè¿‡ä¸‰æ­¥å®Œæˆäº†åˆå§‹åŒ–å¹¶å¯åŠ¨ä¸€ä¸ªè‡ªå®šä¹‰æ§åˆ¶å™¨çš„å·¥ä½œã€‚</p>

<h4 id="ç¬¬ä¸€æ­¥">ç¬¬ä¸€æ­¥ï¼š</h4>

<p>main å‡½æ•°æ ¹æ® Master é…ç½®ï¼ˆAPIServer çš„åœ°å€ç«¯å£å’Œ kubeconfig çš„è·¯å¾„ï¼‰ï¼Œåˆ›å»ºä¸€ä¸ª Kubernetes çš„ clientï¼ˆkubeClientï¼‰å’Œ Network å¯¹è±¡çš„ clientï¼ˆnetworkClientï¼‰ã€‚</p>

<p>ä½†æ˜¯ï¼Œå¦‚æœæˆ‘æ²¡æœ‰æä¾› Master é…ç½®å‘¢ï¼Ÿè¿™æ—¶ï¼Œmain å‡½æ•°ä¼šç›´æ¥ä½¿ç”¨ä¸€ç§åå« InClusterConfig çš„æ–¹å¼æ¥åˆ›å»ºè¿™ä¸ª clientã€‚è¿™ä¸ªæ–¹å¼ï¼Œä¼šå‡è®¾ä½ çš„è‡ªå®šä¹‰æ§åˆ¶å™¨æ˜¯ä»¥ Pod çš„æ–¹å¼è¿è¡Œåœ¨ Kubernetes é›†ç¾¤é‡Œçš„ã€‚Kubernetes é‡Œæ‰€æœ‰çš„ Pod éƒ½ä¼šä»¥ Volume çš„æ–¹å¼è‡ªåŠ¨æŒ‚è½½ Kubernetes çš„é»˜è®¤ ServiceAccountã€‚æ‰€ä»¥ï¼Œè¿™ä¸ªæ§åˆ¶å™¨å°±ä¼šç›´æ¥ä½¿ç”¨é»˜è®¤ ServiceAccount æ•°æ®å·é‡Œçš„æˆæƒä¿¡æ¯ï¼Œæ¥è®¿é—® APIServerã€‚</p>

<p>ç¬¬äºŒæ­¥ï¼šmain å‡½æ•°ä¸º Network å¯¹è±¡åˆ›å»ºä¸€ä¸ªå«ä½œ InformerFactoryï¼ˆå³ï¼šnetworkInformerFactoryï¼‰çš„å·¥å‚ï¼Œå¹¶ä½¿ç”¨å®ƒç”Ÿæˆä¸€ä¸ª Network å¯¹è±¡çš„ Informerï¼Œä¼ é€’ç»™æ§åˆ¶å™¨ã€‚</p>

<p>ç¬¬ä¸‰æ­¥ï¼šmain å‡½æ•°å¯åŠ¨ä¸Šè¿°çš„ Informerï¼Œç„¶åæ‰§è¡Œ controller.Runï¼Œå¯åŠ¨è‡ªå®šä¹‰æ§åˆ¶å™¨ã€‚è‡³æ­¤ï¼Œmain å‡½æ•°å°±ç»“æŸäº†ã€‚çœ‹åˆ°è¿™ï¼Œä½ å¯èƒ½ä¼šæ„Ÿåˆ°éå¸¸å›°æƒ‘ï¼šç¼–å†™è‡ªå®šä¹‰æ§åˆ¶å™¨çš„è¿‡ç¨‹éš¾é“å°±è¿™ä¹ˆç®€å•å—ï¼Ÿè¿™ä¸ª Informer åˆæ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿ</p>

:ET
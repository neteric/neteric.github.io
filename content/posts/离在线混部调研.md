# 离在线混部调研

## 1. 背景

公司战略目标：降本增效

HPA上线使得在线业务的波谷期空闲出大量的计算资源

大数据业务云原生化是必然的趋势，公司大数据团队正在着手落地MR/Spark类的离线业务云原生化

## 2. 业界离在线混部方案分类

按照混合类型分： 分时复用和部分混合和全部混合
按照隔离类型分： 资源独享和资源共享
按照部署方式分： 虚拟机部署和容器部署

这三个维度的组合，目前实际应用中主要是`分时复用 + 独占资源 + 物理机部署`、`部分混合 + 独占资源 + 容器部署`、`全部混合 + 共享资源 + 容器部署` 这三种模式

### 2.1 分时复用 + 独占资源 + 物理机部署

这种组合属于入门级的在离线混部选择，比如物理机运行服务且分时整机腾挪

好处是能够快速实现在离线混部，收获成本降低的红利。技术门槛上，这种方式规避了前面说的复杂的资源隔离问题，并且调度决策足够清晰，服务部署节奏有明确的预期，整个系统可以设计得比较简单。缺点是没有充分发挥出在离线混部的资源利用率潜力，目前主要是一些初创企业在应用。阿里早期在大促期间，将所有离线作业节点下线换上在线服务，也可以看做这种形态的近似版本

### 2.2 部分混合 + 独占资源 + 容器部署

在这种模型下，业务开发人员将服务部署在云原生部署平台，选择某些指标（大部分伴随着流量潮汐特性）来衡量服务负载，平台会按照业务指定规则对服务节点数量扩缩容。当流量低峰期来临时，在线服务会有大量碎片资源可释放，部署平台会整理碎片资源，将碎片资源化零为整后，以整机的方式将资源租借给离线作业使用

### 2.3 全部混合 + 共享资源 + 容器部署

与上述几种方案最大的不同在于，转让的资源规则是动态决策的。在一个大企业中，服务数量数以万计，要求所有在线服务制定扩缩容决策是很难做到的。同时，业务在部署服务时更关注服务稳定性，常常按照最大流量评估资源，这样就导致流量低峰期有大量的资源浪费。
比较典型的是阿里，百度、腾讯的方案

## 3. 离在线混部的问题和难点

### 3.1 资源隔离

离线业务的运行不能影响在线业务的SLA

### 3.2 离线业务的资源保障

### 3.3 离在线调度框架的整合

### 3.4 可观测性体系的建立

### 3.5 部门墙

## 4. 各公司案例特点

## 5. Koordinator 方案介绍

## 6. 总结：中小公司离在线混部实践思路

线上独享内核+容器部署+动态策略
线下共享内核+容器部署+动态策略

## 参考文档

[1] [腾讯：Caelus—全场景在离线混部解决方案](https://cloud.tencent.com/developer/article/1759977)

[2] [字节跳动：自动化弹性伸缩如何支持百万级核心错峰混部](https://cloud.tencent.com/developer/news/653586)

[3] [字节跳动：混布环境下集群的性能评估与优化](https://www.intel.cn/content/www/cn/zh/customer-spotlight/cases/bytedance-performance-evaluation-optimization.html)

[4] [百度大规模战略性混部系统演进](https://www.infoq.cn/article/aeut*zaiffp0q4mskdsg)

[5] [百度混部实践：如何提高 Kubernetes 集群资源利用率？](https://mp.weixin.qq.com/s/12XFN2lPB3grS5FteaF__A)

[6] [阿里巴巴：数据中心日均 CPU 利用率 45% 的运行之道--阿里巴巴规模化混部技术演进](https://developer.aliyun.com/article/651202)

[7] [阿里巴巴：Co-Location of Workloads with High Resource Efficiency](https://static.sched.com/hosted_files/kccncosschn19chi/70/ColocationOnK8s.pdf)

[8] [阿里大规模业务混部下的全链路资源隔离技术演进](https://mp.weixin.qq.com/s/_DTQ4Q2dC-kN3zyozGf9QA)

[9] [一文看懂业界在离线混部技术](https://www.infoq.cn/article/knqswz6qrggwmv6axwqu)

[10] [美团：提升资源利用率与保障服务质量，鱼与熊掌不可兼得？](https://mp.weixin.qq.com/s/hQKM9beWcx7CKMvpJxznfQ)

[11] [B站云原生混部技术实践](https://mp.weixin.qq.com/s/pPEkfrLm0XEpgMU1KjiD4A)

[12] [华为：基于Volcano的离在线业务混部技术探索](https://www.bilibili.com/video/BV1AZ4y1X7AQ/?vd_source=cad2cc6310088fc3945e9d1cb002adee)
